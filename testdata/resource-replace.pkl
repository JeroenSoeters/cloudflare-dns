/*
 * Conformance Test: Replace Resource
 *
 * This file modifies a createOnly field to trigger resource replacement.
 * Changes from resource.pkl:
 *   - name: changed from "formae-test-{testRunID}" to "formae-test-{testRunID}-replaced"
 *
 * The name field has createOnly=true, so formae should delete the
 * existing resource and create a new one with the new name.
 */
amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@cloudflare-dns/cloudflare-dns.pkl" as dns

local stackName = "plugin-sdk-test-stack"
local testRunID = read("env:FORMAE_TEST_RUN_ID")

forma {
  new formae.Stack {
    label = stackName
    description = "Plugin SDK conformance test stack"
  }

  new formae.Target {
    label = "cloudflare-target"
    namespace = "CLOUDFLARE"
    config = new Mapping {
      ["api_token"] = read("env:CLOUDFLARE_API_TOKEN")
      ["zone_id"] = read("env:CLOUDFLARE_ZONE_ID")
    }
  }

  new dns.DNSRecord {
    label = "plugin-sdk-test-record"
    record_type = "A"
    name = "formae-test-\(testRunID)-replaced"            // CHANGED - triggers replacement
    content = "192.0.2.1"
    ttl = 300
    proxied = false
  }
}
