/*
 * Conformance Test: Create Resource
 *
 * This file defines the initial resource state for conformance testing.
 * The conformance test harness will apply this file first.
 */
amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@cloudflare-dns/cloudflare-dns.pkl" as dns

local stackName = "plugin-sdk-test-stack"
// Read the test run ID from environment variable set by the test harness
// This ensures consistent naming within a test run but unique names between runs
local testRunID = read("env:FORMAE_TEST_RUN_ID")

forma {
  new formae.Stack {
    label = stackName
    description = "Plugin SDK conformance test stack"
  }

  new formae.Target {
    label = "cloudflare-target"
    namespace = "CLOUDFLARE"
    config = new Mapping {
      ["api_token"] = read("env:CLOUDFLARE_API_TOKEN")
      ["zone_id"] = read("env:CLOUDFLARE_ZONE_ID")
    }
  }

  new dns.DNSRecord {
    label = "plugin-sdk-test-record"
    record_type = "A"
    name = "formae-test-\(testRunID)"
    content = "192.0.2.1"
    ttl = 300
    proxied = false
  }
}
